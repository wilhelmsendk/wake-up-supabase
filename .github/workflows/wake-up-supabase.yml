name: Wake Up Supabase

on:
  schedule:
    - cron: "0 6 * * *"   # Runs once per day at 06:00 UTC
  workflow_dispatch:       # Allows manual runs

jobs:
  ping-projects:
    runs-on: ubuntu-latest

    steps:
      - name: Validate SUPABASE_PROJECTS_JSON secret exists
        run: |
          if [ -z "${{ secrets.SUPABASE_PROJECTS_JSON }}" ]; then
            echo "‚ùå Secret SUPABASE_PROJECTS_JSON is not set."
            echo "Go to Settings ‚Üí Secrets ‚Üí Actions and add it."
            exit 1
          fi

      - name: Ping Supabase projects to keep them awake
        env:
          SUPABASE_PROJECTS_JSON: ${{ secrets.SUPABASE_PROJECTS_JSON }}
        run: |
          sudo apt-get update -y > /dev/null
          sudo apt-get install -y jq > /dev/null

          LENGTH=$(echo "$SUPABASE_PROJECTS_JSON" | jq '. | length')
          echo "üì¶ Found $LENGTH Supabase project(s)."

          if [ "$LENGTH" -eq 0 ]; then
            echo "‚ö†Ô∏è No projects defined in SUPABASE_PROJECTS_JSON."
            exit 0
          fi

          for i in $(seq 0 $((LENGTH - 1))); do
            URL=$(echo "$SUPABASE_PROJECTS_JSON" | jq -r ".[$i].url")
            KEY=$(echo "$SUPABASE_PROJECTS_JSON" | jq -r ".[$i].anon_key")

            if [ -z "$URL" ] || [ "$URL" = "null" ]; then
              echo "‚ö†Ô∏è Skipping project at index $i ‚Äî missing URL."
              continue
            fi

            if [ -z "$KEY" ] || [ "$KEY" = "null" ]; then
              echo "‚ö†Ô∏è Skipping $URL ‚Äî missing anon_key."
              continue
            fi

            # REST endpoint for DB activity (must exist)
            REST_URL="${URL%/}/rest/v1/keep_alive?select=id&limit=1"

            echo "üåê Pinging DB via: $REST_URL"

            # Allow curl to fail without killing the job
            set +e
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "apikey: $KEY" \
              -H "Authorization: Bearer $KEY" \
              "$REST_URL")
            CURL_EXIT=$?
            set -e

            if [ "$CURL_EXIT" -ne 0 ]; then
              echo "‚ùå Curl failed for $URL (exit code $CURL_EXIT). Skipping."
              continue
            fi

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ $URL responded with HTTP $HTTP_CODE ‚Äî DB activity logged."
            else
              echo "‚ùå $URL responded with HTTP $HTTP_CODE ‚Äî might be paused or invalid."
            fi
          done
